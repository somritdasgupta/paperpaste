name: Security Audit

on:
    schedule:
        # Run security audit every day at 2:00 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch: # Allow manual trigger
    pull_request:
        branches: [main]

jobs:
    security-audit:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v5
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Run security audit
              run: |
                  echo "Running pnpm audit..."
                  pnpm audit --audit-level high

                  echo "Checking for known vulnerabilities..."
                  # Create a report of any high/critical vulnerabilities
                  pnpm audit --json > audit-report.json 2>/dev/null || true

            - name: Upload audit report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: security-audit-report
                  path: audit-report.json
                  retention-days: 30

            - name: Check for critical vulnerabilities
              run: |
                  # If audit-report.json exists and contains vulnerabilities, fail the workflow
                  if [ -f audit-report.json ]; then
                    # Count critical/high vulnerabilities
                    CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' audit-report.json)
                    HIGH=$(jq '.metadata.vulnerabilities.high // 0' audit-report.json)
                    
                    echo "Critical vulnerabilities: $CRITICAL"
                    echo "High vulnerabilities: $HIGH"
                    
                    if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
                      echo "❌ Critical or high severity vulnerabilities found!"
                      echo "Please review the audit report and update dependencies."
                      exit 1
                    else
                      echo "✅ No critical or high severity vulnerabilities found."
                    fi
                  else
                    echo "✅ No vulnerabilities detected."
                  fi
