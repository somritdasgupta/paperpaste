name: Auto-update Dependencies

on:
    # Scheduled runs disabled to avoid creating automatic PRs that may break the app.
    # If you wish to re-enable scheduling, re-add the cron schedule above.
    workflow_dispatch: # Allow manual trigger

jobs:
    update-dependencies:
        runs-on: ubuntu-latest
        permissions:
          contents: write
          # prevent PR creation by removing write permission for pull-requests
          pull-requests: read

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: "20"
                  cache: "pnpm"

            - name: Install pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install

            - name: Update dependencies
              run: |
                  # Update all dependencies to their latest versions
                  pnpm update

                  # Update devDependencies
                  pnpm update --dev

            - name: Run tests (if they exist)
              run: |
                  # Check if there are test scripts
                  if pnpm run --if-present lint; then
                    echo "Linting passed"
                  else
                    echo "No lint script found or linting failed"
                  fi

            - name: Build project to verify updates
              run: |
                  pnpm run build
              env:
                  # Use placeholder environment variables for build
                  NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
                  NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder-key"

            - name: Create Pull Request (draft)
              # Create a draft PR so updates are reviewed and do not merge automatically
              uses: peter-evans/create-pull-request@v6
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: "chore: update dependencies"
                  title: "chore: automatic dependency updates"
                  body: |
                      This PR contains automatic dependency updates.

                      ## Changes
                      - Updated all dependencies to their latest compatible versions
                      - Verified build still works with updated dependencies

                      ## Testing
                      - ✅ Build verification passed
                      - ✅ Linting (if available) passed

                      Please review the changes and merge if everything looks good.

                      ---
                      *This PR was created automatically by the dependency update workflow.*
                  branch: chore/auto-dependency-updates
                  delete-branch: true
                  draft: true
